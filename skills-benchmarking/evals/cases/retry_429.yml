# 429 Retry: Tests pagination helper's 429 handling
# NOTE: This tests INFRASTRUCTURE (pagination helper), not model behavior.
# The model uses paginate:true, so it never sees the 429 directly.
# For model-level 429 testing, see retry_429_nonpaginated.yml

name: retry_429
description: |
  Tests that the pagination helper correctly handles 429 during auto-pagination.
  First request to todos page 2 returns 429 with Retry-After header.
  Helper MUST wait and retry transparently.
  Model completes task without seeing the error.

fixtures:
  - method: GET
    path: "/projects.json"
    response:
      status: 200
      body:
        - id: 1
          name: "Test Project"

  - method: GET
    path: "/projects.json"
    query: {page: "1"}
    response:
      status: 200
      body:
        - id: 1
          name: "Test Project"

  - method: GET
    path: "/projects.json"
    query: {page: "2"}
    response:
      status: 200
      body: []

  - method: GET
    path: "/projects/1.json"
    response:
      status: 200
      body:
        id: 1
        name: "Test Project"
        dock:
          - name: todoset
            id: 10
            enabled: true

  - method: GET
    path: "/buckets/1/todosets/10/todolists.json"
    response:
      status: 200
      body:
        - id: 100
          name: "Main List"

  - method: GET
    path: "/buckets/1/todosets/10/todolists.json"
    query: {page: "1"}
    response:
      status: 200
      body:
        - id: 100
          name: "Main List"

  - method: GET
    path: "/buckets/1/todosets/10/todolists.json"
    query: {page: "2"}
    response:
      status: 200
      body: []

  # No page param = page 1 behavior (agent may not specify ?page=1)
  - method: GET
    path: "/buckets/1/todolists/100/todos.json"
    response:
      status: 200
      body:
        - id: 1001
          content: "Benchmark Seed Todo 1"
          due_on: null
          completed: false

  # Page 1 (explicit)
  - method: GET
    path: "/buckets/1/todolists/100/todos.json"
    query: {page: "1"}
    response:
      status: 200
      body:
        - id: 1001
          content: "Benchmark Seed Todo 1"
          due_on: null
          completed: false

  # Page 2 (success response, used after retry)
  - method: GET
    path: "/buckets/1/todolists/100/todos.json"
    query: {page: "2"}
    response:
      status: 200
      body:
        - id: 1003
          content: "Benchmark Overdue Todo 1"
          due_on: "2020-01-01"
          completed: false

  # Page 3 (explicit empty)
  - method: GET
    path: "/buckets/1/todolists/100/todos.json"
    query: {page: "3"}
    response:
      status: 200
      body: []

  # Comments (empty)
  - method: GET
    path: "/buckets/1/recordings/1003/comments.json"
    response:
      status: 200
      body: []

  # POST comment
  - method: POST
    path: "/buckets/1/recordings/1003/comments.json"
    response:
      status: 201
      body:
        id: 9001
        content: "Processed BenchChain test-run-id"

  # POST completion
  - method: POST
    path: "/buckets/1/todos/1003/completion.json"
    response:
      status: 200
      body:
        id: 1003
        completed: true

# ERROR INJECTION: 429 on first call to page 2
inject:
  - method: GET
    path: "/buckets/1/todolists/100/todos.json"
    query: {page: "2"}
    on_call: 1
    response:
      status: 429
      headers:
        Retry-After: "2"
      body:
        error: "Rate limit exceeded"

assertions:
  required_sequence:
    # First attempt to page 2 (will get 429)
    - method: GET
      path: "/buckets/1/todolists/100/todos.json"
      query: {page: "2"}
      occurrence: 1
      expect_status: 429

    # MUST retry page 2 after waiting
    - method: GET
      path: "/buckets/1/todolists/100/todos.json"
      query: {page: "2"}
      occurrence: 2
      expect_status: 200

  end_state:
    # Must complete the overdue todo (proves retry succeeded)
    - method: POST
      path: "/buckets/1/todos/1003/completion.json"
      count: 1

  forbidden:
    # Invalid URL pattern - todos under todosets/todolists (common model error)
    - method: GET
      path: "/buckets/1/todosets/10/todolists/100/todos.json"

  max_calls: 22  # Extra budget for pagination expansion + 429 retry + model variance

notes:
  - "Received 429 on first page 2 attempt"
  - "Retried page 2 after waiting"
  - "Completed overdue todo (proves retry succeeded)"
