#!/usr/bin/env bash
# bcq - Basecamp Query CLI
# Agent-first CLI for Basecamp API interaction
#
# Usage: bcq <command> [options]
# Run 'bcq' with no arguments for quick-start guide

set -euo pipefail

# Require bash 4+ for associative arrays
if ((BASH_VERSINFO[0] < 4)); then
  echo "bcq requires bash 4.0 or later (found: $BASH_VERSION)" >&2
  echo "" >&2
  if [[ "$(uname)" == "Darwin" ]]; then
    echo "macOS ships with bash 3.2. Install modern bash via Homebrew:" >&2
    echo "  brew install bash" >&2
    echo "" >&2
    echo "Then run bcq with:" >&2
    echo "  /opt/homebrew/bin/bash $(realpath "$0") [args]" >&2
    echo "" >&2
    echo "Or add to your shell config (~/.zshrc or ~/.bash_profile):" >&2
    echo "  alias bcq='/opt/homebrew/bin/bash $HOME/Work/basecamp/bcq/bin/bcq'" >&2
  else
    echo "Install bash 4+ from your package manager." >&2
  fi
  exit 1
fi

# Determine script location for loading libs
BCQ_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
BCQ_VERSION="0.1.0"

# Load libraries
source "$BCQ_ROOT/lib/core.sh"
source "$BCQ_ROOT/lib/config.sh"
source "$BCQ_ROOT/lib/api.sh"
source "$BCQ_ROOT/lib/auth.sh"

# Load command handlers
for cmd_file in "$BCQ_ROOT/lib/commands"/*.sh; do
  [[ -f "$cmd_file" ]] && source "$cmd_file"
done


main() {
  # Parse global flags first
  parse_global_flags "$@"
  shift $GLOBAL_FLAGS_CONSUMED

  # Reload config to pick up command-line flag overrides (e.g., --cache-dir)
  load_config

  # No arguments â†’ quick-start
  if [[ $# -eq 0 ]]; then
    cmd_quick_start
    exit 0
  fi

  local command="$1"
  shift

  case "$command" in
    # Core commands (alphabetical)
    campfire)   cmd_campfire "$@" ;;
    cards)      cmd_cards "$@" ;;
    checkins)   cmd_checkins "$@" ;;
    comments)   cmd_comments "$@" ;;
    docs)       cmd_docs "$@" ;;
    files)      cmd_files "$@" ;;
    me)         cmd_me "$@" ;;
    messages)   cmd_messages "$@" ;;
    people)     cmd_people "$@" ;;
    projects)   cmd_projects "$@" ;;
    recordings) cmd_recordings "$@" ;;
    schedule)   cmd_schedule "$@" ;;
    search)     cmd_search "$@" ;;
    show)       cmd_show "$@" ;;
    subscriptions) cmd_subscriptions "$@" ;;
    todolists)  cmd_todolists "$@" ;;
    todolistgroups) cmd_todolistgroups "$@" ;;
    todos)      cmd_todos "$@" ;;
    uploads)    cmd_uploads "$@" ;;
    vaults)     cmd_vaults "$@" ;;
    webhooks)   cmd_webhooks "$@" ;;

    # Action shortcuts
    todo)       cmd_todo_create "$@" ;;
    done)       cmd_todo_complete "$@" ;;
    reopen)     cmd_todo_uncomplete "$@" ;;
    message)    cmd_message "$@" ;;
    card)       cmd_card "$@" ;;
    comment)    cmd_comment "$@" ;;
    assign)     cmd_assign "$@" ;;
    unassign)   cmd_unassign "$@" ;;

    # Auth & config
    auth)       cmd_auth "$@" ;;
    config)     cmd_config "$@" ;;

    # MCP server
    mcp)        cmd_mcp "$@" ;;

    # Meta
    version)    echo "bcq $BCQ_VERSION" ;;
    help|--help|-h)
      cmd_help "$@"
      ;;

    *)
      json_error "Unknown command: $command" "usage" \
        "Run 'bcq' for available commands"
      exit 1
      ;;
  esac
}

# Run main with all arguments
main "$@"
