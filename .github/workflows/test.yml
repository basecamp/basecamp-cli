name: Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  test:
    name: Go Tests
    runs-on: ubuntu-latest
    env:
      BCQ_NO_KEYRING: "1"
    steps:
      - uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.24'

      - name: Run unit tests
        run: go test -race -v ./...

      - name: Run govulncheck
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          govulncheck ./...

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v9
        with:
          version: v2.1.6

      - name: Build binary
        run: go build -o bin/bcq ./cmd/bcq

      - name: Smoke test
        run: |
          ./bin/bcq --version
          ./bin/bcq --help | head -5

  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    env:
      BCQ_NO_KEYRING: "1"
    steps:
      - uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.24'

      - name: Build binary
        run: go build -o bin/bcq ./cmd/bcq

      - name: Install BATS
        run: |
          git clone https://github.com/bats-core/bats-core.git /tmp/bats-core
          sudo /tmp/bats-core/install.sh /usr/local

      - name: Install test dependencies
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Run BATS integration tests
        run: bats e2e/

  benchmarks:
    name: Benchmarks
    runs-on: ubuntu-latest
    env:
      BCQ_NO_KEYRING: "1"
    steps:
      - uses: actions/checkout@v6

      - name: Check for internal changes
        if: github.event_name == 'pull_request'
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            internal:
              - 'internal/**'

      # Run benchmarks on: main pushes (always), PRs (only if internal/ changed)
      - name: Set up Go
        if: github.event_name != 'pull_request' || steps.filter.outputs.internal == 'true'
        uses: actions/setup-go@v6
        with:
          go-version: '1.24'

      - name: Run benchmarks
        if: github.event_name != 'pull_request' || steps.filter.outputs.internal == 'true'
        run: go test -bench=. -benchmem -count=3 ./internal/... | tee benchmarks.txt

      - name: Download previous benchmark baseline
        if: github.event_name != 'pull_request' || steps.filter.outputs.internal == 'true'
        uses: actions/cache/restore@v5
        with:
          path: benchmarks-baseline.txt
          key: benchmarks-${{ github.base_ref || 'main' }}
          restore-keys: |
            benchmarks-main

      - name: Install benchstat
        if: github.event_name != 'pull_request' || steps.filter.outputs.internal == 'true'
        run: go install golang.org/x/perf/cmd/benchstat@latest

      - name: Compare benchmarks
        if: (github.event_name != 'pull_request' || steps.filter.outputs.internal == 'true') && hashFiles('benchmarks-baseline.txt') != ''
        run: |
          echo "## Benchmark Comparison" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          benchstat benchmarks-baseline.txt benchmarks.txt >> $GITHUB_STEP_SUMMARY 2>&1 || true
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Check for significant regression
        if: (github.event_name != 'pull_request' || steps.filter.outputs.internal == 'true') && hashFiles('benchmarks-baseline.txt') != ''
        run: |
          benchstat benchmarks-baseline.txt benchmarks.txt > comparison.txt 2>&1 || true
          # Warn on >20% regression but don't fail (benchmarks can be noisy)
          if grep -E '\+[2-9][0-9]\.[0-9]+%|\+[1-9][0-9][0-9]+' comparison.txt; then
            echo "::warning::Potential performance regression detected (>20% slower in some benchmarks)"
          fi

      - name: Save benchmark baseline (main branch only)
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        uses: actions/cache/save@v5
        with:
          path: benchmarks.txt
          key: benchmarks-main-${{ github.sha }}

      - name: Update baseline cache alias
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: cp benchmarks.txt benchmarks-baseline.txt

      - name: Save baseline alias
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        uses: actions/cache/save@v5
        with:
          path: benchmarks-baseline.txt
          key: benchmarks-main

      - name: Upload benchmark results
        if: github.event_name != 'pull_request' || steps.filter.outputs.internal == 'true'
        uses: actions/upload-artifact@v6
        with:
          name: benchmarks
          path: benchmarks.txt
          retention-days: 30
